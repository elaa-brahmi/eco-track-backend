name: CI/CD — Build → Test → Scan → Push → Deploy (Separated Jobs)

on:
  push:
    branches: [ main, develop,peterEvans-osrm ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  packages: write
  security-events: write

# ──────────────────────────────────────────────────────────────
# 1. Build & Test (runs on every push/PR)
# ──────────────────────────────────────────────────────────────
jobs:
  build-and-test:
    runs-on: ubuntu-latest
    name: Build & Test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Build & Test
        run: mvn -B -ntp clean verify -DskipTests=false -Dtest=!OsrmIntegrationTest,*Test

      - name: Upload Surefire Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports/

      - name: Upload JaCoCo Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-coverage
          path: target/site/jacoco/


  # ──────────────────────────────────────────────────────────────
  # 2. Build & Push Docker Image (only if tests pass)
  # ──────────────────────────────────────────────────────────────
  build-and-push:
    needs: build-and-test
    runs-on: ubuntu-latest
    name: Build & Push Image
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    env:
      IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/ecotrack-backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.ACCESS_TOKEN_GITHUB }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:sha-${{ github.sha }}
            ${{ env.IMAGE_NAME }}:${{ github.ref_name }}
            ${{ env.IMAGE_NAME }}:latest
          labels: |
            org.opencontainers.image.source=${{ github.event.repository.html_url }}
            org.opencontainers.image.revision=${{ github.sha }}


  # ──────────────────────────────────────────────────────────────
  # 3. Security Scan (parallel, independent)
  # ──────────────────────────────────────────────────────────────
  security-scan:
    needs: build-and-test
    runs-on: ubuntu-latest
    name: Trivy Security Scan
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build image for scanning
        run: docker build -t ecotrack-backend:scan .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ecotrack-backend:scan
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH

      - name: Upload Trivy results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif


  # ──────────────────────────────────────────────────────────────
  # 4. Deploy to Kind (only on main, after everything passes)
  # ──────────────────────────────────────────────────────────────
  deploy-to-kind:
    needs: [build-and-push, security-scan]
    runs-on: ubuntu-latest
    name: Deploy to Kind (Test Cluster)
    if: github.ref == 'refs/heads/main'
    env:
      KIND_CLUSTER_NAME: ecotrack

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Kind cluster
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.24.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind create cluster --name ${{ env.KIND_CLUSTER_NAME }} --wait 120s || true

      - name: Load images into Kind
        run: |
          docker pull ghcr.io/${{ github.repository_owner }}/ecotrack-backend:latest
          docker pull peter-evans/osrm-backend-docker:latest
          kind load docker-image ghcr.io/${{ github.repository_owner }}/ecotrack-backend:latest --name ${{ env.KIND_CLUSTER_NAME }}
          kind load docker-image peter-evans/osrm-backend-docker:latest --name ${{ env.KIND_CLUSTER_NAME }}

      - name: Deploy manifests
        run: |
          kubectl apply -f k8s/backend.yaml
          kubectl apply -f k8s/osrm.yaml   # ← your updated osrm.yaml with peter-evans image

      - name: Smoke Test (Backend + OSRM)
        run: |
          kubectl wait --for=condition=available deployment/ecotrack-backend --timeout=5m
          kubectl wait --for=condition=available deployment/osrm --timeout=12m || true   # OSRM needs time on first run
          kubectl port-forward svc/ecotrack-backend 8080:8080 &
          kubectl port-forward svc/osrm 5001:5000 &
          sleep 40
          curl -f http://localhost:8080/actuator/health || exit 1
          curl -f "http://localhost:5001/route/v1/driving/10.1667,36.8065;10.1911,36.8006?steps=true" || exit 1
          echo "DEPLOYED SUCCESSFULLY TO KIND CLUSTER"

      - name: Success Notification
        if: success()
        run: echo "Full CI/CD pipeline completed successfully!"