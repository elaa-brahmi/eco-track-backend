FROM osrm/osrm-backend:latest

RUN echo "deb http://deb.debian.org/debian bookworm main" > /etc/apt/sources.list && \
    echo "deb http://deb.debian.org/debian bookworm-updates main" >> /etc/apt/sources.list && \
    echo "deb http://security.debian.org/debian-security bookworm-security main" >> /etc/apt/sources.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends wget ca-certificates && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /data

# Download Tunisia map
RUN wget -q https://download.geofabrik.de/africa/tunisia-latest.osm.pbf

# Process the map (cached after first build)
RUN osrm-extract -p /opt/car.lua tunisia-latest.osm.pbf && \
    osrm-partition tunisia-latest.osrm && \
    osrm-customize tunisia-latest.osrm

EXPOSE 5000

CMD ["osrm-routed", "--algorithm", "mld", "tunisia-latest.osrm"]